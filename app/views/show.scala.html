@(wsUri:String,simArea:String = "LINESTRING (-30 -10, -10 -30, -40 -40)")
@main("Ships") {
<link href='@routes.Assets.versioned("leaflet/leaflet.css")' rel="stylesheet">
<script src='@routes.Assets.versioned("leaflet/leaflet.js")'></script>
<script src='@routes.Assets.versioned("javascripts/terraformer.min.js")'></script>
<script src='@routes.Assets.versioned("javascripts/terraformer-wkt-parser.min.js")'></script>
<div id="map" style="height: 100%; width: 100%;"></div>
<script>

   function Ship(imo,marker) {
        this.imo = imo;
        this.marker = marker;
    }

function loadMap() {

    function Position(lat,lon,timestamp) {
        this.lat = lat;
        this.lon = lon;
        this.timestamp = timestamp;
    }

    window.map = L.map('map', {
        center: [-22, -43],
        zoom: 6
    });

    window.map.ships = new Array();

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {
      maxZoom: 20,
      minZoom: 2
    }).addTo(window.map);

    var simArea = '@simArea';
    var simAreaGeoJSON = Terraformer.WKT.parse(simArea);
    L.geoJson(simAreaGeoJSON).addTo(map);

}

  loadMap();


  function init()
  {
    testWebSocket();
  }

  function testWebSocket() {
    wsUrl = '@wsUri';

    console.log('Vou me loggar em ' + wsUrl);
    websocket = new WebSocket(wsUrl);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt) {
    doSend("register");
  }

  function onClose(evt) {

  }

  function onMessage(evt) {
    pos = $.parseJSON(evt.data);
    var ship = new Ship(pos.imoNumber,L.marker([pos.position.latitude,pos.position.longitude]))
    i = 0;
    var found = false;
    for (i = 0; i<window.map.ships.length; i++) {
        if (window.map.ships[i].imo === ship.imo) {
            window.map.ships[i].marker.setLatLng(ship.marker.getLatLng());
            found = true;
        }
    }
    if (!found) {
        ship.marker.addTo(map);
        ship.marker.bindPopup('<b>' + pos.imoNumber + '</b>');
        window.map.ships.push(ship);
    }
  }

  function onError(evt){ }

  function doSend(message) {
    websocket.send(message);
  }

  window.addEventListener("load", init, false);
</script>
}